name: Update Versions.json

on:
    release:
        types: [published]

jobs:
    update_versions:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
            - name: Get version from manifest
              id: get_version
              run: |
                  VERSION=$(jq -r '.package_version' manifest.json)
                  echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            - name: Download zipball and get hash
              id: get_hash
              run: |
                  ZIP_URL="${{ github.event.release.zipball_url }}"
                  curl -L -o release.zip "$ZIP_URL"
                  HASH=$(sha256sum release.zip | awk '{print $1}')
                  echo "HASH=$HASH" >> $GITHUB_OUTPUT
            - name: Update versions.json
              run: |
                  VERSION=${{ steps.get_version.outputs.VERSION }}
                  HASH=${{ steps.get_hash.outputs.HASH }}
                  jq --arg ver "$VERSION" --arg hash "$HASH" --arg url "${{ github.event.release.zipball_url }}" \
                     '.versions += [{"package_version": $ver, "sha256": $hash, "download_url": $url}]' \
                     versions.json > versions.tmp.json
                  mv versions.tmp.json versions.json
            - name: Commit and push changes
              uses: stefanzweifel/git-auto-commit-action@v7
              with:
                  commit_message: "Update versions.json for release ${{ steps.get_version.outputs.VERSION }}"
                  branch: main
